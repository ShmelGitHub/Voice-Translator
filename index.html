window.onload = function() {
    var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
    recognition.lang = 'ru-RU';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    var resultDisplay = document.getElementById('speechResult');
    var statusIndicator = document.getElementById('statusIndicator');
    var toggleButton = document.getElementById('toggleButton');
    var responseElement = document.getElementById('response');
    var fadeOutTimer; // Глобальная переменная для таймера анимации fade-out

    recognition.onresult = function(event) {
        var speechResult = event.results[0][0].transcript;
        resultDisplay.textContent = speechResult;
        responseElement.classList.remove('hidden'); // Показываем распознанный текст
        clearTimeout(fadeOutTimer); // Прерываем таймер при получении распознавания
        sendToServer(speechResult); // Вызываем функцию sendToServer при каждом результате распознавания
    };

    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') { // Проверяем тип ошибки
            startFadeOutWithDelay(); // Запускаем fade-out с задержкой только если тип ошибки no-speech
        }
    };

    recognition.onend = function() {
        if (!resultDisplay.textContent) { // Проверяем наличие текста в speechResult
            startFadeOut(); // Запускаем fade-out только если speechResult пустой
        }
        recognition.start(); // После завершения распознавания начинаем его снова
    };

    recognition.start(); // Начинаем распознавание при загрузке страницы

    function sendToServer(text) {
        var encodedText = encodeURIComponent(text);
        var url = 'https://cors-anywhere-j2ux.onrender.com/https://busy-lime-betta-suit.cyclic.app/gpt/' + encodedText;

        // Изменяем цвет квадратика на зеленый при отправке запроса
        statusIndicator.style.backgroundColor = 'green';

        fetch(url)
        .then(response => response.text())
        .then(data => {
            displayResponse(data);
            // Изменяем цвет квадратика на желтый при получении ответа
            statusIndicator.style.backgroundColor = 'yellow';
            // Если есть распознанный текст, отменяем таймер для fade-out
            if (resultDisplay.textContent) {
                clearTimeout(fadeOutTimer);
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            // Изменяем цвет квадратика на красный при ошибке
            statusIndicator.style.backgroundColor = 'red';
            // Запускаем fade-out с задержкой при ошибке
            startFadeOutWithDelay();
        });
    }

    function displayResponse(responseText) {
        setTimeout(function() {
            responseElement.textContent = responseText;
            responseElement.classList.add('fade-in'); // Добавляем класс для анимации появления
        }, 100); // Задержка перед сменой текста в миллисекундах
    }

    function startFadeOut() {
        fadeOutTimer = setTimeout(function() {
            responseElement.classList.add('fade-out'); // Добавляем класс для анимации исчезновения
            setTimeout(function() {
                responseElement.style.display = 'none'; // Скрываем элемент
                responseElement.classList.remove('fade-out'); // Удаляем класс анимации исчезновения
            }, 1000); // Длительность анимации исчезновения
        }, 5000); // Длительность задержки перед скрытием текста
    }

    function startFadeOutWithDelay() {
        setTimeout(startFadeOut, 500); // Задержка перед запуском fade-out
    }

    // Функция для переключения видимости распознанного текста
    toggleButton.onclick = function() {
        if (resultDisplay.style.display === 'none') {
            resultDisplay.style.display = 'inline';
        } else {
            resultDisplay.style.display = 'none';
        }
    };

    // Удаление стиля display: none; после завершения анимации fade-out
    responseElement.addEventListener('animationend', function(event) {
        if (event.animationName === 'fadeOut') {
            responseElement.textContent = ''; // Обнуляем содержимое элемента
            responseElement.style.display = 'none'; // Скрываем элемент
            responseElement.classList.remove('fade-out'); // Удаляем класс анимации исчезновения
        }
    });
};
